{% extends "base.html" %}
{% block title %}Dashboard — Bet Tracker{% endblock %}

{% block content %}
<div class="page-header">
  <h1>Dashboard</h1>
  <p class="subtitle">Partidos ESPN + analisis IA + picks guardados</p>
</div>

<div class="stats-bar">
  <div class="stat-pill total">
    <span>Total</span>
    <span class="stat-value">{{ stats.total }}</span>
  </div>
  <div class="stat-pill bet">
    <span>BET</span>
    <span class="stat-value">{{ stats.bet }}</span>
  </div>
  <div class="stat-pill lean">
    <span>LEAN</span>
    <span class="stat-value">{{ stats.lean }}</span>
  </div>
  <div class="stat-pill no-bet">
    <span>NO BET</span>
    <span class="stat-value">{{ stats.no_bet }}</span>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h3>Partidos de ESPN</h3>
    <div class="actions-row">
      <button class="btn btn-primary btn-sm" id="load-espn-btn">Traer partidos ESPN</button>
    </div>
  </div>
  <p class="text-muted" id="espn-status">Selecciona el boton para cargar partidos.</p>
  <div class="table-wrap mt-2">
    <table>
      <thead>
        <tr>
          <th>Liga</th>
          <th>Partido</th>
          <th>Hora (UTC)</th>
          <th>Estado</th>
          <th>Accion</th>
        </tr>
      </thead>
      <tbody id="espn-events-body">
        <tr><td colspan="5" class="table-empty">Aun no se cargaron partidos.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div class="card mt-3">
  <div class="card-header">
    <h3>Picks guardados</h3>
  </div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Juego</th>
          <th>Resultado</th>
          <th>Market</th>
          <th style="text-align:center;">Confianza</th>
          <th style="text-align:right;">EV</th>
          <th style="text-align:right;">Stake</th>
        </tr>
      </thead>
      <tbody>
        {% for pick in picks %}
          {% set game = games.get(pick.game_id) %}
          <tr>
            <td>
              {% if game %}
                <div class="matchup compact">
                  <span class="team-name">{{ game.home_team }}</span>
                  <span class="vs-divider">vs</span>
                  <span class="team-name">{{ game.away_team }}</span>
                </div>
                <div class="text-xs text-muted mt-1">
                  <span class="league-badge {{ game.league|lower }}">{{ game.league }}</span>
                </div>
              {% else %}
                <span class="text-muted">Game #{{ pick.game_id }}</span>
              {% endif %}
            </td>
            <td>
              {% if pick.result == 'BET' %}
                <span class="badge badge-bet">{{ pick.emoji }} BET</span>
              {% elif pick.result == 'LEAN' %}
                <span class="badge badge-lean">{{ pick.emoji }} LEAN</span>
              {% else %}
                <span class="badge badge-no-bet">{{ pick.emoji }} NO BET</span>
              {% endif %}
            </td>
            <td>
              <span class="font-bold">{{ pick.market or '-' }}</span>
              {% if pick.selection %}<div class="text-xs text-muted">{{ pick.selection }}</div>{% endif %}
            </td>
            <td style="text-align:center;">
              <span class="text-sm font-bold">{{ pick.confidence }}%</span>
            </td>
            <td style="text-align:right;">{{ ('%+.1f%%'|format(pick.ev)) if pick.ev is not none else '-' }}</td>
            <td style="text-align:right;">{{ ('%.2fu'|format(pick.stake_u)) if pick.stake_u else '-' }}</td>
          </tr>
        {% else %}
          <tr><td colspan="6" class="table-empty">No hay picks guardados todavia.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div id="analysis-modal" class="modal-overlay hidden" role="dialog" aria-modal="true">
  <div class="modal-card">
    <div class="card-header">
      <h3 id="analysis-modal-title">Analisis IA</h3>
      <button class="btn btn-outline btn-sm" id="close-analysis-modal">Cerrar</button>
    </div>
    <div id="analysis-modal-body" class="modal-body"></div>
  </div>
</div>

<script>
(function() {
  const loadBtn = document.getElementById('load-espn-btn');
  const statusEl = document.getElementById('espn-status');
  const eventsBody = document.getElementById('espn-events-body');
  const modal = document.getElementById('analysis-modal');
  const closeModalBtn = document.getElementById('close-analysis-modal');
  const modalTitle = document.getElementById('analysis-modal-title');
  const modalBody = document.getElementById('analysis-modal-body');

  let currentEvents = [];

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = String(text ?? '');
    return div.innerHTML;
  }

  function setStatus(msg, isError=false) {
    statusEl.textContent = msg;
    statusEl.classList.toggle('error-text', isError);
  }

  function formatDate(iso) {
    if (!iso) return '-';
    return iso.replace('T', ' ').replace('+00:00', ' UTC');
  }

  function renderEvents(events) {
    if (!events.length) {
      eventsBody.innerHTML = '<tr><td colspan="5" class="table-empty">No se encontraron partidos.</td></tr>';
      return;
    }
    let html = '';
    events.forEach((event, index) => {
      html += '<tr>'
        + '<td><span class="league-badge ' + escapeHtml(String((event.league || '').toLowerCase())) + '">' + escapeHtml(event.league || '-') + '</span></td>'
        + '<td><strong>' + escapeHtml(event.away_team) + '</strong> vs <strong>' + escapeHtml(event.home_team) + '</strong></td>'
        + '<td>' + escapeHtml(formatDate(event.start_time_utc)) + '</td>'
        + '<td><span class="status-' + escapeHtml((event.status || '').toLowerCase()) + '">' + escapeHtml(event.status || '-') + '</span></td>'
        + '<td><button class="btn btn-secondary btn-sm analyze-btn" data-idx="' + index + '">Analizar partido</button></td>'
        + '</tr>';
    });
    eventsBody.innerHTML = html;
  }

  async function fetchEspnEvents() {
    setStatus('Cargando partidos ESPN...');
    loadBtn.disabled = true;
    try {
      const resp = await fetch('/api/espn/events?league=NBA');
      const data = await resp.json();
      if (!data.ok) {
        setStatus('Error cargando ESPN: ' + (data.error || 'desconocido'), true);
        eventsBody.innerHTML = '<tr><td colspan="5" class="table-empty">No se pudieron cargar partidos.</td></tr>';
        return;
      }
      currentEvents = data.events || [];
      renderEvents(currentEvents);
      setStatus('Partidos cargados: ' + currentEvents.length);
    } catch (e) {
      setStatus('Error de red cargando partidos: ' + String(e), true);
    } finally {
      loadBtn.disabled = false;
    }
  }

  function openModal() {
    modal.classList.remove('hidden');
  }

  function closeModal() {
    modal.classList.add('hidden');
    modalBody.innerHTML = '';
  }

  function renderNonPickResponse(analysis) {
    const message = analysis.message || 'Respuesta no estandar de IA';
    return '<div class="notice notice-warning"><strong>' + escapeHtml(message) + '</strong></div>'
      + '<pre class="raw-block">' + escapeHtml(JSON.stringify(analysis.raw_result, null, 2)) + '</pre>';
  }

  function pickCard(event, pick, rawAiJson, idx) {
    return '<div class="pick-card">'
      + '<div class="pick-grid">'
      + '<div><strong>Resultado:</strong> ' + escapeHtml(pick.result) + '</div>'
      + '<div><strong>Market:</strong> ' + escapeHtml(pick.market || '-') + '</div>'
      + '<div><strong>Seleccion:</strong> ' + escapeHtml(pick.selection || '-') + '</div>'
      + '<div><strong>Cuota:</strong> ' + escapeHtml(pick.odds || '-') + '</div>'
      + '<div><strong>Confianza:</strong> ' + escapeHtml(pick.confidence) + '%</div>'
      + '<div><strong>EV:</strong> ' + escapeHtml(pick.ev || '-') + '</div>'
      + '</div>'
      + '<div class="mt-2"><button class="btn btn-primary btn-sm save-pick-btn" data-pick-idx="' + idx + '">Guardar pick</button></div>'
      + '</div>';
  }

  async function analyzeEvent(event) {
    modalTitle.textContent = 'Analisis IA: ' + (event.away_team || '-') + ' vs ' + (event.home_team || '-');
    modalBody.innerHTML = '<p class="text-muted">Analizando partido con IA...</p>';
    openModal();

    try {
      const resp = await fetch('/api/ai/analyze-event', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ event })
      });
      const analysis = await resp.json();
      if (!analysis.ok) {
        modalBody.innerHTML = '<div class="notice notice-error">' + escapeHtml(analysis.message || 'Error analizando partido') + '</div>';
        return;
      }

      if (analysis.analysis_type !== 'picks') {
        modalBody.innerHTML = renderNonPickResponse(analysis);
        return;
      }

      const picks = analysis.picks || [];
      if (!picks.length) {
        modalBody.innerHTML = renderNonPickResponse(analysis);
        return;
      }

      let html = '';
      picks.forEach((pick, idx) => {
        html += pickCard(event, pick, analysis.raw_ai_json, idx);
      });
      modalBody.innerHTML = html;

      modalBody.querySelectorAll('.save-pick-btn').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const pickIdx = Number(btn.dataset.pickIdx);
          const pick = picks[pickIdx];
          btn.disabled = true;
          btn.textContent = 'Guardando...';
          try {
            const saveResp = await fetch('/api/picks/save', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ event, pick, raw_ai_json: analysis.raw_ai_json })
            });
            const saveData = await saveResp.json();
            if (!saveResp.ok || !saveData.ok) {
              throw new Error(saveData.detail || saveData.message || 'No se pudo guardar');
            }
            btn.textContent = 'Guardado ✅';
            window.setTimeout(() => window.location.reload(), 500);
          } catch (e) {
            btn.disabled = false;
            btn.textContent = 'Guardar pick';
            alert('Error guardando pick: ' + String(e));
          }
        });
      });
    } catch (e) {
      modalBody.innerHTML = '<div class="notice notice-error">Error llamando analisis IA: ' + escapeHtml(String(e)) + '</div>';
    }
  }

  eventsBody.addEventListener('click', (event) => {
    const target = event.target;
    if (!(target instanceof HTMLElement)) return;
    const btn = target.closest('.analyze-btn');
    if (!btn) return;
    const idx = Number(btn.dataset.idx);
    if (!Number.isFinite(idx) || idx < 0 || idx >= currentEvents.length) return;
    analyzeEvent(currentEvents[idx]);
  });

  closeModalBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (event) => {
    if (event.target === modal) closeModal();
  });
  loadBtn.addEventListener('click', fetchEspnEvents);
})();
</script>
{% endblock %}
