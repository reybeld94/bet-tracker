{% extends "base.html" %}
{% block title %}Ingesta GPT â€” Bet Tracker{% endblock %}

{% block content %}
<div class="page-header">
  <h1>Ingesta GPT</h1>
  <p class="subtitle">Pega el analisis y genera picks en estado DRAFT. No se aprueba nada automaticamente.</p>
</div>

<div class="breadcrumb">
  <a href="/">Dashboard</a>
  <span class="sep">/</span>
  <span>Ingesta</span>
</div>

<div class="card mb-3">
  <form method="post" action="/ingest">
    <div class="form-group">
      <label>Pega aqui el texto del GPT</label>
      <textarea name="text" placeholder="Bucks +1.5 -130 1u" style="min-height:140px;">{{ text }}</textarea>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Sport (opcional)</label>
        <select name="sport">
          <option value="">(Todos)</option>
          {% for s in sports %}
            <option value="{{ s }}" {% if s == selected_sport %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>League (opcional)</label>
        <select name="league">
          <option value="">(Todas)</option>
          {% for l in leagues %}
            <option value="{{ l }}" {% if l == selected_league %}selected{% endif %}>{{ l }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>GPT Name (opcional)</label>
        <input name="gpt_name" placeholder="MiGPT-Bets" value="{{ gpt_name }}" />
      </div>
      <div class="form-group">
        <label>Source</label>
        <input name="source" placeholder="AI" value="{{ source }}" />
      </div>
    </div>

    <button type="submit" class="btn btn-primary">Parse</button>
  </form>
</div>

{% if picks %}
  <div class="card">
    <div class="card-header">
      <h3>Review de picks propuestos</h3>
      <span class="badge badge-draft">{{ picks|length }}</span>
    </div>
    <form method="post" action="/ingest/create">
      <input type="hidden" name="pick_count" value="{{ picks|length }}" />
      <input type="hidden" name="gpt_name" value="{{ gpt_name }}" />
      <input type="hidden" name="source" value="{{ source }}" />

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Event</th>
              <th>Market</th>
              <th>Side</th>
              <th>Line</th>
              <th>Odds</th>
              <th>Stake</th>
              <th>Rec</th>
              <th>Notas</th>
            </tr>
          </thead>
          <tbody>
            {% for pick in picks %}
              <tr>
                <td>
                  <select name="pick-{{ loop.index0 }}-event_id" style="min-width:160px;">
                    <option value="">(Sin evento)</option>
                    {% for event in events %}
                      <option value="{{ event.id }}" {% if event.id == pick.event_id %}selected{% endif %}>
                        {{ event.home_team }} vs {{ event.away_team }}
                      </option>
                    {% endfor %}
                  </select>
                  {% if pick.error %}
                    <div style="color:var(--accent-red);font-weight:700;font-size:0.8rem;margin-top:4px;">{{ pick.error }}</div>
                  {% endif %}
                </td>
                <td>
                  <select name="pick-{{ loop.index0 }}-market_type">
                    <option value="ML" {% if pick.market_type == "ML" %}selected{% endif %}>ML</option>
                    <option value="SPREAD" {% if pick.market_type == "SPREAD" %}selected{% endif %}>SPREAD</option>
                    <option value="TOTAL" {% if pick.market_type == "TOTAL" %}selected{% endif %}>TOTAL</option>
                  </select>
                  <input type="hidden" name="pick-{{ loop.index0 }}-period" value="FG" />
                </td>
                <td>
                  <select name="pick-{{ loop.index0 }}-side">
                    <option value="">(Selecciona)</option>
                    <option value="HOME" {% if pick.side == "HOME" %}selected{% endif %}>HOME</option>
                    <option value="AWAY" {% if pick.side == "AWAY" %}selected{% endif %}>AWAY</option>
                    <option value="OVER" {% if pick.side == "OVER" %}selected{% endif %}>OVER</option>
                    <option value="UNDER" {% if pick.side == "UNDER" %}selected{% endif %}>UNDER</option>
                  </select>
                </td>
                <td><input name="pick-{{ loop.index0 }}-line" value="{{ pick.line if pick.line is not none else '' }}" style="width:60px;" /></td>
                <td><input name="pick-{{ loop.index0 }}-odds" value="{{ pick.odds }}" style="width:70px;" /></td>
                <td><input name="pick-{{ loop.index0 }}-stake" value="{{ pick.stake }}" style="width:50px;" /></td>
                <td>
                  <select name="pick-{{ loop.index0 }}-recommendation">
                    <option value="BET" {% if pick.recommendation == "BET" %}selected{% endif %}>BET</option>
                    <option value="LEAN" {% if pick.recommendation == "LEAN" %}selected{% endif %}>LEAN</option>
                    <option value="PASS" {% if pick.recommendation == "PASS" %}selected{% endif %}>PASS</option>
                  </select>
                </td>
                <td>
                  <input name="pick-{{ loop.index0 }}-reasoning" value="{{ pick.raw_line }}" style="min-width:120px;" />
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="mt-2">
        <button type="submit" class="btn btn-primary">Create Drafts</button>
      </div>
    </form>
  </div>
{% endif %}
{% endblock %}
